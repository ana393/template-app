name: Publish to Exchange & Deploy to CH2.0

on:
  pull_request_target:
    branches: [ development, uat, main ]
    types: [ closed ]

env:
  MAVEN_OPTS: -Xmx1024m
  JAVA_VERSION: 17
  JAVA_DISTRIBUTION: zulu

jobs:
  # Deploy job (runs only when PR is merged)
  deploy:
    name: Deploy to ${{ github.event.pull_request.base.ref }}
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.pull_request.base.ref == 'main' && 'production' || github.event.pull_request.base.ref }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ github.ref_name }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-${{ github.ref_name }}-
            ${{ runner.os }}-maven-

      # - name: Run MUnit Tests
      #   env:
      #     MUNIT_SECURE_KEY: ${{ secrets.MUNIT_SECURE_KEY || secrets.SECURE_KEY }}
      #   run: |
      #     # Coverage threshold set to 20% for initial testing
      #     # TODO: Increase to 80% for UAT and production deployments
      #     mvn clean test \
      #       -Denv=test \
      #       -DsecureKey="${MUNIT_SECURE_KEY}" \
      #       -Dmunit.app.coverage=20 \
      #       -Dmunit.coverage.fail.build=true

      # - name: Upload MUnit Coverage Report
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: munit-coverage-report-${{ github.event.pull_request.base.ref }}
      #     path: target/site/munit/coverage/
      #     retention-days: 30

      - name: Set environment variables
        id: set-env
        run: |
          BRANCH="${{ github.event.pull_request.base.ref }}"
          REPO_NAME="${{ github.event.repository.name }}"

          # Set environment-specific variables
          if [[ "$BRANCH" == "development" ]]; then
            echo "env_suffix=dev" >> $GITHUB_OUTPUT
            echo "maven_profile=Sandbox" >> $GITHUB_OUTPUT
            echo "exchange_profile=$REPO_NAME-v1-dev" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "uat" ]]; then
            echo "env_suffix=uat" >> $GITHUB_OUTPUT
            echo "maven_profile=Sandbox" >> $GITHUB_OUTPUT
            echo "exchange_profile=$REPO_NAME-v1-uat" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "main" ]]; then
            echo "env_suffix=prod" >> $GITHUB_OUTPUT
            echo "maven_profile=prod" >> $GITHUB_OUTPUT
            echo "exchange_profile=$REPO_NAME-v1-prod" >> $GITHUB_OUTPUT
          fi

      - name: Build and Publish to Exchange
        run: |
          echo "Publishing to Exchange with debug output"
          echo "Client ID is set: ${{ secrets.CONNECTED_APP_CLIENT_ID != '' }}"
          echo "Client Secret is set: ${{ secrets.CONNECTED_APP_CLIENT_SECRET != '' }}"
          echo "Settings file: .maven/settings.xml"
          mvn -s .maven/settings.xml clean deploy -DskipTests -X \
            -Dclient.id="${{ secrets.CONNECTED_APP_CLIENT_ID }}" \
            -Dclient.secret="${{ secrets.CONNECTED_APP_CLIENT_SECRET }}"

      - name: Deploy to CloudHub 2.0
        run: |
          echo "Deploying to CloudHub 2.0 with ${{ steps.set-env.outputs.maven_profile }} profile..."
          mvn deploy --settings .maven/settings.xml -DskipMunitTests -DmuleDeploy \
            -P${{ steps.set-env.outputs.maven_profile }} \
            -Dclient.id="${{ secrets.CONNECTED_APP_CLIENT_ID }}" \
            -Dclient.secret="${{ secrets.CONNECTED_APP_CLIENT_SECRET }}" \
            -DenvSufix="${{ steps.set-env.outputs.env_suffix }}" \
            -DsecureKey="${{ secrets.SECURE_KEY }}"
          echo "Deployment completed successfully"
